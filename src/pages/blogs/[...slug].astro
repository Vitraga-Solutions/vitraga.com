---
import { getCollection, type CollectionEntry } from "astro:content";
import MainLayout from "../../layouts/MainLayout.astro";
import { COMPANY_NAME } from "../../constants";
import TableOfContents from "../../components/ui/TableOfContents.astro";

export const getStaticPaths = async () => {
	const blogs = await getCollection("blogs");
	return blogs.map((blog) => {
		return {
			params: {
				slug: blog.slug,
			},
			props: { blog },
		};
	});
};

type Props = {
	blog: CollectionEntry<"blogs">;
};

const { blog } = Astro.props;
const { Content, headings } = await blog.render();

const { title, excerpt, coverImage, publishedDate, tags } = blog.data;

const wordCount = blog.body.split(/\s+/).length;
const readTime = Math.ceil(wordCount / 200);

// Transform headings for TOC component
const tocHeadings = headings.map(heading => ({
  id: heading.slug,
  text: heading.text,
  level: heading.depth
}));

export const prerender = true;
---

<MainLayout title={title} description={excerpt || title}>
  <article class="min-h-screen">
    <!-- Article Header -->
    <header class="py-16 px-4 bg-gradient-to-b from-[rgba(9,9,9,0.03)] to-white">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8">
          <a href="/blogs" class="text-dark hover:text-green transition-colors duration-200 font-medium">
            ← Back to Blog
          </a>
        </nav>

        <!-- Title -->
        <h1 class="text-4xl lg:text-5xl font-bold text-dark mb-6 font-grotesk leading-tight">
          {title}
        </h1>

		<!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-6">
          {tags.map((tag: string) => (
            <span class="bg-green text-black text-sm font-medium px-3 py-1 rounded-full">
              {tag}
            </span>
          ))}
        </div>

        <!-- Excerpt -->
        {excerpt && (
          <p class="text-xl text-gray-600 mb-8 leading-relaxed">
            {excerpt}
          </p>
        )}

        <!-- Meta Info -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
          <div class="flex items-center space-x-4">
              <img 
                src={"/logo.png"} 
                alt={COMPANY_NAME}
                class="w-12 h-12 rounded-full object-cover"
              />
            <div>
              <p class="font-medium text-dark">{COMPANY_NAME}</p>
              <p class="text-gray-600 text-sm">{publishedDate}</p>
            </div>
          </div>
          <div class="flex items-center space-x-6 text-sm text-gray-600">
            <span>{readTime} min read</span>
            <span>{wordCount} words</span>
          </div>
        </div>

        <!-- Cover Image -->
        {coverImage && (
          <div class="rounded-2xl overflow-hidden shadow-lg">
            <img 
              src={coverImage.src} 
              alt={title}
              class="w-full h-64 md:h-96 object-cover"
            />
          </div>
        )}
      </div>
    </header>

    <!-- Article Content -->
    <main class="px-4">
      <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <!-- Table of Contents Sidebar -->
          <div class="lg:col-span-1">
            <div class="lg:sticky lg:top-36">
              <!-- Mobile TOC Toggle -->
              <div class="lg:hidden mb-6">
                <button 
                  id="toc-toggle"
                  class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-dark font-medium hover:bg-gray-100 transition-colors duration-200"
                  aria-expanded="false"
                  aria-controls="mobile-toc"
                >
                  <span>Table of Contents</span>
                  <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                <div id="mobile-toc" class="hidden mt-2">
                  <TableOfContents headings={tocHeadings} />
                </div>
              </div>

              <!-- Desktop TOC -->
              <div class="hidden lg:block">
                <TableOfContents headings={tocHeadings} />
              </div>
            </div>
          </div>
          <!-- Main Content -->
          <div class="lg:col-span-3">
            <div class="prose prose-lg prose-gray max-w-none
                        prose-headings:font-grotesk prose-headings:font-bold 
                        prose-headings:text-dark prose-headings:leading-tight
                        prose-h1:text-4xl prose-h1:mb-8 prose-h1:mt-12
                        prose-h2:text-3xl prose-h2:mb-6 prose-h2:mt-10 prose-h2:border-b prose-h2:border-gray-200 prose-h2:pb-2
                        prose-h3:text-2xl prose-h3:mb-4 prose-h3:mt-8
                        prose-h4:text-xl prose-h4:mb-4 prose-h4:mt-6
                        prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
                        prose-a:text-dark prose-a:font-medium hover:prose-a:text-green prose-a:transition-colors
                        prose-strong:text-dark prose-strong:font-semibold
                        prose-ul:my-6 prose-ol:my-6
                        prose-li:my-2 prose-li:text-gray-700
                        prose-blockquote:border-l-4 prose-blockquote:border-green prose-blockquote:bg-gray-50 prose-blockquote:p-4 prose-blockquote:rounded-r-lg prose-blockquote:my-6
                        prose-code:text-green prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-medium
                        prose-pre:bg-dark prose-pre:text-white prose-pre:rounded-xl prose-pre:p-6 prose-pre:my-8 prose-pre:overflow-x-auto
                        prose-img:rounded-lg prose-img:shadow-lg prose-img:my-8
                        prose-hr:border-gray-300 prose-hr:my-12
                        prose-table:my-8
                        prose-th:bg-gray-50 prose-th:font-semibold prose-th:text-dark
                        prose-td:border-gray-200
                        content">
              <Content />
            </div>
          </div>
        </div>
      </div>
    </main>
      </div>
      <!-- Article Footer -->
        <div class="max-w-4xl mx-auto col-span-3 lg:p-0 p-5">
          <footer class="mt-16 pt-8 border-t border-gray-200">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
              <!-- Author Info -->
              <div class="flex items-center space-x-4">
                  <img 
                    src={"/logo.png"} 
                    alt={COMPANY_NAME}
                    class="w-16 h-16 rounded-full object-cover"
                  />
                <div>
                  <h3 class="font-semibold text-dark text-lg">Written by {COMPANY_NAME}</h3>
                  <p class="text-gray-600">Published on {publishedDate}</p>
                </div>
              </div>

              <!-- Share Buttons -->
              <div class="flex items-center space-x-4">
                <span class="text-gray-600 font-medium">Share:</span>
                <a 
                  href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 bg-gray-100 hover:bg-green text-dark hover:text-black rounded-lg transition-colors duration-200"
                  aria-label="Share on Twitter"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                  </svg>
                </a>
                <a 
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 bg-gray-100 hover:bg-green text-dark hover:text-black rounded-lg transition-colors duration-200"
                  aria-label="Share on LinkedIn"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                  </svg>
                </a>
              </div>
            </div>
          </footer>

          <!-- Navigation -->
          <nav class="my-12 pt-8 border-t border-gray-200">
            <a 
              href="/blogs"
              class="inline-flex items-center px-6 py-3 bg-dark text-white rounded-lg hover:bg-green hover:text-black transition-colors duration-200 font-medium"
            >
              ← Back to All Articles
            </a>
          </nav>
        </div>
    </main>
  </article>
</MainLayout>

<script>
  // Add copy buttons to code blocks
  document.addEventListener('DOMContentLoaded', function() {
    const codeBlocks = document.querySelectorAll('pre');
    
    codeBlocks.forEach((block) => {
      // Create copy button
      const button = document.createElement('button');
      button.className = 'copy-button';
      button.innerHTML = 'Copy';
	  button.style.position = 'absolute';
	  button.style.top = '10px';
	  button.style.right = '10px';

      button.setAttribute('aria-label', 'Copy code to clipboard');
      
      // Add click handler
      button.addEventListener('click', async () => {
        const code = block.querySelector('code');
        if (code) {
          try {
            await navigator.clipboard.writeText(code.textContent || '');
            button.innerHTML = 'Copied!';
            button.classList.add('copied');
            
            // Reset button after 2 seconds
            setTimeout(() => {
              button.innerHTML = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy code: ', err);
            button.innerHTML = 'Error';
            setTimeout(() => {
              button.innerHTML = 'Copy';
            }, 2000);
          }
        }
      });
      
      // Add button to code block
      block.appendChild(button);
    });

    // Mobile TOC toggle functionality
    const tocToggle = document.getElementById('toc-toggle');
    const mobileToc = document.getElementById('mobile-toc');
    
    if (tocToggle && mobileToc) {
      tocToggle.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        const toggleIcon = this.querySelector('svg');
        
        // Toggle visibility
        if (isExpanded) {
          mobileToc.classList.add('hidden');
          this.setAttribute('aria-expanded', 'false');
          if (toggleIcon) {
            toggleIcon.style.transform = 'rotate(0deg)';
          }
        } else {
          mobileToc.classList.remove('hidden');
          this.setAttribute('aria-expanded', 'true');
          if (toggleIcon) {
            toggleIcon.style.transform = 'rotate(180deg)';
          }
        }
      });
    }
  });
</script>