---
import MainLayout from "../../layouts/MainLayout.astro";
import Section from "../../components/sections/Section.astro";
import { marked } from 'marked';
import { jobs } from "../../data/jobsData.js";

const { id } = Astro.params;
const jobId = id;

const job = jobs.find((j) => j.id.toString() === jobId);

if (!job) {
  return Astro.redirect('/careers');
}

marked.setOptions({
  breaks: true,
  gfm: true,
});

const htmlDescription = await marked(job.description);
console.log(htmlDescription);
---

<MainLayout title={`${job.title} - Careers`} description={`Apply for ${job.title} position at our company.`}>
  <Section>
    <div class="py-20">
      <!-- Back Button -->
      <div class="mb-8">
        <a 
          href="/careers"
          class="inline-flex items-center text-black hover:text-black-600 transition-colors duration-200 text-sm font-medium"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Careers
        </a>
      </div>

      <!-- Main Content Grid -->
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Left Column - Job Description -->
        <div class="space-y-8">
          <div>
            <h1 class="text-3xl md:text-4xl font-bold text-black mb-4">{job.title}</h1>
            <div class="flex flex-wrap gap-4 text-sm text-black">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Hybrid (Bangalore, India) / Remote
              </span>
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2V6" />
                </svg>
                Full-time
              </span>
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                2â€“5 years experience
              </span>
            </div>
          </div>

          <!-- Job Description Content -->
          <div class="prose prose-lg max-w-none job-description">
            <div set:html={htmlDescription} />
          </div>
        </div>

        <!-- Right Column - Application Form -->
        <div class="lg:sticky lg:top-8 lg:self-start">
          <div class="bg-[#F3F3F3] rounded-[24px] p-8 border border-dark shadow-[0px_5px_0px_#191a23]">
            <h2 class="text-xl font-bold text-black mb-6">Apply for this Position</h2>
            
            <form id="job-application-form" class="space-y-6">
              <input type="hidden" name="job_id" value={job.id} />
              
              <div id="dynamic-form-fields"></div>
              
              <!-- Submit Button -->
              <button 
                type="submit"
                class="w-full px-6 py-4 bg-black text-white rounded-[14px] hover:bg-gray-800 transition-colors duration-200 font-medium text-lg"
              >
                Submit Application
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </Section>
</MainLayout>

<script define:vars={{ jobFields: job.fields }}>
  document.addEventListener('DOMContentLoaded', () => {
    const dynamicFields = document.getElementById('dynamic-form-fields');
    const form = document.getElementById('job-application-form');
    
    // Get URL parameters using URLSearchParams (for any additional client-side params)
    const urlParams = new URLSearchParams(window.location.search);
    
    // Generate form fields
    if (dynamicFields && jobFields) {
      jobFields.forEach(field => {
        const fieldElement = createFormField(field);
        dynamicFields.appendChild(fieldElement);
      });
    }
    
    // Handle form submission
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
          if (data[key]) {
            if (Array.isArray(data[key])) {
              data[key].push(value);
            } else {
              data[key] = [data[key], value];
            }
          } else {
            data[key] = value;
          }
        }
        
        console.log('Application data:', data);
        
        // Here you would send to your API
        alert('Application submitted successfully! We will get back to you soon.');
      });
    }
  });
  
  function createFormField(field) {
    const fieldContainer = document.createElement('div');
    fieldContainer.className = 'mb-6';
    
    const label = document.createElement('label');
    label.className = 'block text-black mb-2 font-medium';
    label.textContent = field.label + (field.required ? '*' : '');
    
    let input;
    
    switch (field.type) {
      case 'text':
      case 'email':
      case 'number':
        input = document.createElement('input');
        input.type = field.type;
        input.name = field.name;
        input.required = field.required;
        input.className = 'w-full px-4 py-3 border border-gray-300 rounded-[14px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors';
        input.placeholder = field.label;
        break;
        
      case 'textarea':
        input = document.createElement('textarea');
        input.name = field.name;
        input.required = field.required;
        input.rows = 4;
        input.className = 'w-full px-4 py-3 border border-gray-300 rounded-[14px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors resize-vertical';
        input.placeholder = field.label;
        break;
        
      case 'select':
        input = document.createElement('select');
        input.name = field.name;
        input.required = field.required;
        input.className = 'w-full px-4 py-3 border border-gray-300 rounded-[14px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select ' + field.label;
        input.appendChild(defaultOption);
        
        if (field.options) {
          field.options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            input.appendChild(optionElement);
          });
        }
        break;
        
      case 'radio':
        input = document.createElement('div');
        input.className = 'space-y-3';
        
        if (field.options) {
          field.options.forEach(option => {
            const radioContainer = document.createElement('div');
            radioContainer.className = 'flex items-center';
            
            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.name = field.name;
            radioInput.value = option;
            radioInput.required = field.required;
            radioInput.className = 'mr-3 w-4 h-4 text-blue-600';
            radioInput.id = `${field.name}_${option}`;
            
            const radioLabel = document.createElement('label');
            radioLabel.textContent = option;
            radioLabel.htmlFor = `${field.name}_${option}`;
            radioLabel.className = 'cursor-pointer text-black';
            
            radioContainer.appendChild(radioInput);
            radioContainer.appendChild(radioLabel);
            input.appendChild(radioContainer);
          });
        }
        break;
        
      case 'checkbox':
        input = document.createElement('div');
        input.className = 'space-y-3';
        
        if (field.options) {
          field.options.forEach(option => {
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'flex items-center';
            
            const checkboxInput = document.createElement('input');
            checkboxInput.type = 'checkbox';
            checkboxInput.name = field.name;
            checkboxInput.value = option;
            checkboxInput.className = 'mr-3 w-4 h-4 text-blue-600';
            checkboxInput.id = `${field.name}_${option}`;
            
            const checkboxLabel = document.createElement('label');
            checkboxLabel.textContent = option;
            checkboxLabel.htmlFor = `${field.name}_${option}`;
            checkboxLabel.className = 'cursor-pointer text-black';
            
            checkboxContainer.appendChild(checkboxInput);
            checkboxContainer.appendChild(checkboxLabel);
            input.appendChild(checkboxContainer);
          });
        }
        break;
        
      case 'file':
        input = document.createElement('input');
        input.type = 'file';
        input.name = field.name;
        input.required = field.required;
        input.accept = field.name === 'resume' ? '.pdf,.doc,.docx' : '*/*';
        input.className = 'w-full px-4 py-3 border border-gray-300 rounded-[14px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-[14px] file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100';
        break;
        
      default:
        input = document.createElement('input');
        input.type = 'text';
        input.name = field.name;
        input.required = field.required;
        input.className = 'w-full px-4 py-3 border border-gray-300 rounded-[14px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors';
        break;
    }
    
    fieldContainer.appendChild(label);
    fieldContainer.appendChild(input);
    
    return fieldContainer;
  }
</script>

<style>
  .job-description :global(h1) {
    font-size: 2.5rem;
  }
  
  .job-description :global(h2) {
    font-size: 2rem;
  }
  
  .job-description :global(h3) {
    font-size: 1.5rem;
  }

  .job-description :global(hr) {
    border-color: #D1D5DB; /* Tailwind gray-300 */
    margin: 1.5rem 0;
  }
</style>